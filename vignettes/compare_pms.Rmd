---
title: "Compare 4iiii, Kickr, and Stages"
output:
  html_document:
    theme: spacelab
    highlight: default
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10
)
```

```{r setup}
library(cyclingpower)
library(dplyr)
library(ggplot2)
library(tidylog)
library(glue)

ggplot2::theme_set(ggplot2::theme_minimal())
```

Comparing power readings across the Stages Chorus LHS power meter and 4iiii Precision LHS power meter by referencing them both to the same Wahoo Kickr Core. The Kickr was set to erg mode and ran the same programme for two separate runs, one with each power meter.

```{r read_data}
folder <- "~/Downloads/power_meter_comparison/"
all_files <- list.files(folder)
data_names <- c(
  "run1_pm4iiii",
  "run2_pmStages",
  "run3_pm4iiii",
  "run1_kickr",
  "run2_kickr",
  "run3_kickr"
)
alldata <- purrr::map2(
  .x = all_files,
  .y = data_names,
  .f = ~ cyclingpower::read_file(glue::glue("{folder}{.x}")) %>%
    tidylog::select(timestamp, power)
) %>%
  setNames(data_names)
```

## 4iiii power meter vs Kickr Core

### Run 1

Before the test:

- Left the power meter without a battery for several hours
- Did a factory reset using the 4iiii app
- Did a zero offset using the 4iiii app

```{r descriptive_stats_run1}
run1_4iiii <-
  tidylog::left_join(
    alldata$run1_kickr,
    alldata$run1_pm4iiii,
    by = "timestamp"
  ) %>%
  tidylog::rename(
    power_kickr = power.x,
    power_4iiii = power.y
  )

run1_4iiii %>%
  skim_power_data() %>%
  knitr::kable()
```

```{r run1_charts}
compare_ts(run1_4iiii)
compare_distribution(run1_4iiii, power_4iiii, power_kickr)
diff_by_var(run1_4iiii, power_4iiii, power_kickr, power_kickr)
diff_by_var(run1_4iiii, power_4iiii, power_kickr, timestamp)
```

### Run 3

Before the test:

- Did a spindown calibration of the Kickr Core
- Did a zero offset using Wahoo Elemnt Bolt headunit

```{r descriptive_stats_run3}
run3_4iiii <-
  tidylog::left_join(
    alldata$run3_kickr,
    alldata$run3_pm4iiii,
    by = "timestamp"
  ) %>%
  tidylog::rename(
    power_kickr = power.x,
    power_4iiii = power.y
  )

run3_4iiii %>%
  skim_power_data() %>%
  knitr::kable()
```

```{r run3_charts}
compare_ts(run3_4iiii)
compare_distribution(run3_4iiii, power_4iiii, power_kickr)
diff_by_var(run3_4iiii, power_4iiii, power_kickr, power_kickr)
diff_by_var(run3_4iiii, power_4iiii, power_kickr, timestamp)
```

## Stages Chorus power meter vs Kickr Core

Before the test:

- Left the power meter without a battery for several hours
- Did a zero offset using the Stages app

```{r descriptive_stats_run2}
run2_stages <-
  tidylog::left_join(
    alldata$run2_kickr,
    alldata$run2_pmStages,
    by = "timestamp"
  ) %>%
  tidylog::rename(
    power_kickr = power.x,
    power_stages = power.y
  )

run2_stages %>%
  skim_power_data() %>%
  knitr::kable()
```

```{r run2_charts}
compare_ts(run2_stages)
compare_distribution(run2_stages, power_stages, power_kickr)
diff_by_var(run2_stages, power_stages, power_kickr, power_kickr)
diff_by_var(run2_stages, power_stages, power_kickr, timestamp)
```
